# Теперь поговорим про оптимизацию

---

## До оптимизации

Воспользуемся программой callgrind, она выдает суммарную *стоимость* программы - refs

В качестве теста будем заполнять таблицу базой на 200 тыс слов, а потом искать каждое слово 10 раз.

Время посмотреть на первый скрин

![Screenshot from 2022-04-19 15-34-49](https://user-images.githubusercontent.com/89395114/164006341-f610771e-f9e5-4d46-838f-a92b7395d9e7.png)

Это отчет данной программы для не оптимизированной версии хеш-таблицы.

Refs = 450 млн

![Screenshot from 2022-04-19 15-34-52](https://user-images.githubusercontent.com/89395114/164006524-bae902a4-f044-4efe-90bc-c78350e8b0ae.png)

Как мы можем заметить, наибольший вклад вносит функция поиска элементов, далее идет хеш функция и strncmp. 

Применив всю свою силу воли я решил не переписывать strncmp, а переписать таблицу под работу с m256i переменными, так как это даст возможность использовать интринсики, которые заменят strncmp, и использовать crc_hash, который будет явно быстрее murmurHash-а !

В результате программа станет требовательнее по памяти, но зато значительно быстрее.

---

## После оптимизации

![Screenshot from 2022-04-19 15-59-05](https://user-images.githubusercontent.com/89395114/164012038-3c702e59-1109-4b97-81ac-c9f645c52ed8.png)

Refs = 272 млн

Как мы можем заметить, ситуация кардинально изменилась, теперь наибольший вклад вносит функция поиска (что логично, учитывая специфику теста)

На самом деле до этой финальной версии были и другие, так что справедливости ради стоит сказать, что такой уровень быстродействия был достигнут также за счет некоторых манипуляций с логикой программы, но промежуточных результатов нет, так как я забыл их сохранить.

Смысла оптимизтировать функции, кроме функции поиска нет, так как это даст незначительный вклад в общюю картину.

А если говорить о функции поиска - то тут проще уже некуда, там и так используется минимум инструкций, достаточный для корректной работы программы.

Так что я решил остановиться на этой отметке. 

__Итого : программа стала работать на 40% быстрее, то есть примерно в 1,7 раза.__

КПД = 43. 

UPD:

## После замены calloc на malloc со своим memset (написанном на ассемблере) были получены следующие изменения:

![Screenshot from 2022-05-08 00-00-07](https://user-images.githubusercontent.com/89395114/167271689-520be381-33cd-45f3-b329-fcc117ad57c7.png)

Refs = 254 млн

Тоесть программа ускорилась еще на 7 процентов

## Подытог

Последняя оптимизация ускорила программу всего на 7 процентов, при том единоразово (так как calloc применяется только при инициализации таблицы), значит при увеличении тестовой нагрузки, например, если я буду искать каждое слово не по 10 раз, а по 100, данные 7 процентов ускорения станут меньше чем 1 процентом. Поэтому я делаю вывод, что дальнейшие попытки оптимизации бессмысленны, так как в постоянно работающей части таблицы (функции поиска и вставки), на мой взгляд ускорять нечего. 

__Итоговый итог : программа стала работать на 47% быстрее, то есть примерно в 1,75 раза.__

КПД = 45.
